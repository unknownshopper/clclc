<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Evaluaciones - Café La Cabaña</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js CDN para gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase Scripts -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAnfQSqfJSSQ6QBrYyF4rWUhCZmIAqGb90",
        authDomain: "clclc-24987.firebaseapp.com",
        projectId: "clclc-24987",
        storageBucket: "clclc-24987.firebasestorage.app",
        messagingSenderId: "266489305461",
        appId: "1:266489305461:web:2ce3fbdc212a61064d5b3c"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Firebase functions for evaluations
      window.firebaseDB = {
        // Guardar evaluación en Firestore
        async guardarEvaluacion(evaluacionData) {
          try {
            const docRef = await addDoc(collection(db, 'evaluaciones'), {
              ...evaluacionData,
              fechaCreacion: new Date(),
              timestamp: Date.now()
            });
            console.log('Evaluación guardada en Firebase con ID:', docRef.id);
            return docRef.id;
          } catch (error) {
            console.error('Error guardando evaluación en Firebase:', error);
            throw error;
          }
        },

        // Cargar evaluaciones desde Firestore
        async cargarEvaluaciones(mes = null) {
          try {
            let q = collection(db, 'evaluaciones');
            
            if (mes) {
              q = query(q, where('mes', '==', mes), orderBy('fechaCreacion', 'desc'));
            } else {
              q = query(q, orderBy('fechaCreacion', 'desc'));
            }
            
            const querySnapshot = await getDocs(q);
            const evaluaciones = [];
            
            querySnapshot.forEach((doc) => {
              evaluaciones.push({
                id: doc.id,
                ...doc.data()
              });
            });
            
            console.log(`Cargadas ${evaluaciones.length} evaluaciones desde Firebase`);
            
            // Integrar evaluaciones en la estructura local
            this.integrarEvaluacionesEnEstructuraLocal(evaluaciones);
            
            return evaluaciones;
          } catch (error) {
            console.error('Error cargando evaluaciones desde Firebase:', error);
            return [];
          }
        },

        // Integrar evaluaciones de Firebase en la estructura local
        integrarEvaluacionesEnEstructuraLocal(evaluacionesFirebase) {
          if (!window.evaluaciones) {
            window.evaluaciones = { sucursales: {}, franquicias: {} };
          }
          
          evaluacionesFirebase.forEach(evalFirebase => {
            const { tipo, entidadId, mes, parametros, totalObtenido, totalMaximo, kpi, estado, fechaCreacion, created_at, timestamp } = evalFirebase;
            
            if (tipo && entidadId && mes) {
              // Determinar el tipo de entidad
              const tipoEntidad = tipo === 'sucursal' ? 'sucursales' : 'franquicias';
              
              // Inicializar estructura si no existe
              if (!window.evaluaciones[tipoEntidad]) {
                window.evaluaciones[tipoEntidad] = {};
              }
              if (!window.evaluaciones[tipoEntidad][entidadId]) {
                window.evaluaciones[tipoEntidad][entidadId] = {};
              }
              
              // Integrar la evaluación con todos los datos necesarios
              const evaluacionLocal = {
                parametros: parametros || {},
                totalObtenido: totalObtenido || 0,
                totalMaximo: totalMaximo || 0,
                kpi: kpi || 0,
                estado: estado || 'Pendiente',
                fechaCreacion: fechaCreacion,
                created_at: created_at,
                timestamp: timestamp
              };
              
              window.evaluaciones[tipoEntidad][entidadId][mes] = evaluacionLocal;
            }
          });
          
          console.log('Evaluaciones de Firebase integradas en estructura local');
          console.log('Estructura actual:', window.evaluaciones);
        },

        // Eliminar evaluación de Firestore
        async eliminarEvaluacion(entidadId, tipo, mes) {
          try {
            // Buscar el documento por entidadId, tipo y mes
            const q = query(
              collection(db, 'evaluaciones'), 
              where('entidadId', '==', entidadId),
              where('tipo', '==', tipo),
              where('mes', '==', mes)
            );
            
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
              // Eliminar todos los documentos que coincidan (debería ser solo uno)
              const deletePromises = [];
              querySnapshot.forEach((doc) => {
                deletePromises.push(deleteDoc(doc.ref));
              });
              
              await Promise.all(deletePromises);
              console.log(`Evaluación eliminada de Firebase: ${entidadId} (${tipo}) - ${mes}`);
              return true;
            } else {
              console.log('No se encontró la evaluación en Firebase para eliminar');
              return false;
            }
          } catch (error) {
            console.error('Error eliminando evaluación de Firebase:', error);
            throw error;
          }
        },

        // Actualizar evaluación en Firestore
        async actualizarEvaluacion(entidadId, tipo, mes, evaluacionData) {
          try {
            // Buscar el documento existente
            const q = query(
              collection(db, 'evaluaciones'), 
              where('entidadId', '==', entidadId),
              where('tipo', '==', tipo),
              where('mes', '==', mes)
            );
            
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
              // Actualizar el documento existente
              const doc = querySnapshot.docs[0];
              await updateDoc(doc.ref, {
                ...evaluacionData,
                fechaModificacion: new Date(),
                timestampModificacion: Date.now()
              });
              console.log(`Evaluación actualizada en Firebase: ${entidadId} (${tipo}) - ${mes}`);
              return doc.id;
            } else {
              console.log('No se encontró la evaluación en Firebase para actualizar');
              return null;
            }
          } catch (error) {
            console.error('Error actualizando evaluación en Firebase:', error);
            throw error;
          }
        },

        // Verificar conexión a Firebase
        async verificarConexion() {
          try {
            await getDocs(query(collection(db, 'evaluaciones'), orderBy('fechaCreacion', 'desc')));
            console.log('Conexión a Firebase establecida correctamente');
            return true;
          } catch (error) {
            console.error('Error conectando a Firebase:', error);
            return false;
          }
        }
      };

      console.log('Firebase configurado correctamente');
    </script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="/logo.png" alt="Café La Cabaña" class="logo-img"> <br>
                <h1>Sistema de Evaluaciones</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <span id="userRole" class="user-role"></span>
                <button onclick="cerrarSesion()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </header>
    
    <nav>
        <button class="tab-btn" data-section="dashboard">Dashboard</button>
        <button class="tab-btn" data-section="evaluaciones">Evaluaciones</button>
        <button class="tab-btn" data-section="matriz">Matriz</button>
        <button class="tab-btn" data-section="graficas">Gráficas</button>
    </nav>
    <main>
        <section id="dashboard" class="tab-section">
            <div class="mes-selector-container">
                <label for="mes-selector">Mes de evaluación:</label>
                <select id="mes-selector"></select>
            </div>
            <!-- KPIs y resumen general -->
        </section>
        <section id="evaluaciones" class="tab-section" style="display:none"></section>
        <section id="matriz" class="tab-section" style="display:none">
            <h2>Matriz de Evaluación (Sucursales y Franquicias)</h2>
            <div id="tabla-matriz-container"></div>
        </section>
        <section id="graficas" class="tab-section" style="display:none">
            <canvas id="graficaResultados" width="600" height="300"></canvas>
        </section>
    </main>
    <script src="data/sucursales.js"></script>
    <script src="data/franquicias.js"></script>
    <script src="data/parametros.js"></script>
    <script src="data/parametros_excluidos.js"></script>
    <script src="data/usuarios.js"></script>
    <script src="script.js"></script>
    <style>
        /* Estilos para la tabla de evaluaciones */
        .evaluaciones-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .evaluaciones-table th,
        .evaluaciones-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .evaluaciones-table th {
            background-color: #0561ff;
            font-weight: bold;
        }
        
        /* Estilos para las celdas de KPI */
        .kpi-alto {
            background-color: #b7e1cd;
            color: #0b5394;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-medio {
            background-color: #ffe599;
            color: #7f6000;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-bajo {
            background-color: #f4cccc;
            color: #990000;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-na {
            background-color: #f3f3f3;
            color: #666666;
            text-align: center;
            font-style: italic;
        }
    </style>
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: block;">
      <div class="modal-content" style="max-width: 400px; margin: 10% auto;">
        <div class="modal-header">
          <h2><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</h2>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="Ingrese su email" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Contraseña:</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="Ingrese su contraseña" required>
          </div>
          <div id="loginError" class="error-message" style="display: none; color: #e74c3c; margin-top: 10px; text-align: center;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="iniciarSesion()">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
          </button>
        </div>
      </div>
    </div>
    <!-- Modal para nueva evaluación -->
    <div id="modal-nueva-evaluacion">
      <div class="modal-box">
        <button onclick="cerrarModalEvaluacion()" class="close-btn">&times;</button>
        <h2>Nueva evaluación</h2>
        <label for="select-entidad-evaluacion">Sucursal/Franquicia:</label>
        <select id="select-entidad-evaluacion" style="width:100%;margin-bottom:16px;">
          <option value="">Selecciona una opción</option>
          <!-- Opciones generadas por JS -->
        </select>
        <div id="parametros-evaluacion-container"></div>
        <div id="total-puntos-evaluacion" style="margin:18px 0 0 0;font-weight:600;font-size:1.08em;color:#0077cc;">Total de puntos: 0</div>
        <button id="btn-guardar-evaluacion" style="margin-top:16px;display:none;">Guardar evaluación</button>
      </div>
    </div>
    <footer>
      <img src="logch.png" alt="The Unknown Shopper" class="logo-TUS">
      <p>The Unknown Shopper &copy; 2025 | Todos los derechos reservados.</p>
    </footer>
</body>
</html>