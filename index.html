<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Evaluaciones - Café La Cabaña</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js CDN para gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase Scripts -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      
      // Import Firebase configuration from separate file
      import { firebaseConfig } from './firebase-config.js';

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Import video links
      import { videoLinks } from './data/video_links.js';
      window.videoLinks = videoLinks;

      // Firebase functions for evaluations
      window.firebaseDB = {
        // Guardar evaluación en Firestore
        async guardarEvaluacion(evaluacionData) {
          try {
            const docRef = await addDoc(collection(db, 'evaluaciones'), {
              ...evaluacionData,
              fechaCreacion: new Date(),
              timestamp: Date.now()
            });
            console.log('Evaluación guardada en Firebase con ID:', docRef.id);
            return docRef.id;
          } catch (error) {
            console.error('Error guardando evaluación en Firebase:', error);
            throw error;
          }
        },

        // Cargar evaluaciones desde Firestore
        async cargarEvaluaciones(mes = null) {
          try {
            let q = collection(db, 'evaluaciones');
            
            if (mes) {
              q = query(q, where('mes', '==', mes), orderBy('fechaCreacion', 'desc'));
            } else {
              q = query(q, orderBy('fechaCreacion', 'desc'));
            }
            
            const querySnapshot = await getDocs(q);
            const evaluaciones = [];
            
            querySnapshot.forEach((doc) => {
              evaluaciones.push({
                id: doc.id,
                ...doc.data()
              });
            });
            
            console.log(`Cargadas ${evaluaciones.length} evaluaciones desde Firebase`);
            return evaluaciones;
          } catch (error) {
            console.error('Error cargando evaluaciones desde Firebase:', error);
            return [];
          }
        },

        // Eliminar evaluación de Firestore
        async eliminarEvaluacion(entidadId, tipo, mes) {
          try {
            // Buscar la evaluación por entidadId, tipo y mes
            const q = query(
              collection(db, 'evaluaciones'),
              where('entidadId', '==', entidadId),
              where('tipo', '==', tipo),
              where('mes', '==', mes)
            );
            
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
              console.log(`No se encontró evaluación para eliminar: ${entidadId} (${tipo}) - ${mes}`);
              return false;
            }
            
            // Eliminar todos los documentos que coincidan (debería ser solo uno)
            const deletePromises = [];
            querySnapshot.forEach((doc) => {
              console.log(`Eliminando documento Firebase: ${doc.id}`);
              deletePromises.push(deleteDoc(doc.ref));
            });
            
            await Promise.all(deletePromises);
            console.log(`Evaluación eliminada de Firebase: ${entidadId} (${tipo}) - ${mes}`);
            return true;
          } catch (error) {
            console.error('Error eliminando evaluación de Firebase:', error);
            throw error;
          }
        },

        // Actualizar evaluación en Firestore
        async actualizarEvaluacion(evaluacionId, datosActualizados) {
          try {
            await updateDoc(doc(db, 'evaluaciones', evaluacionId), {
              ...datosActualizados,
              fechaActualizacion: new Date(),
              timestampActualizacion: Date.now()
            });
            console.log('Evaluación actualizada en Firebase:', evaluacionId);
            return true;
          } catch (error) {
            console.error('Error actualizando evaluación en Firebase:', error);
            throw error;
          }
        },

        // Actualizar estado de publicación de una evaluación
        async actualizarEstadoPublicacion(entidadId, tipo, mes, nuevoEstado) {
          try {
            // Buscar la evaluación por entidadId, tipo y mes
            const q = query(
              collection(db, 'evaluaciones'),
              where('entidadId', '==', entidadId),
              where('tipo', '==', tipo),
              where('mes', '==', mes)
            );
    
            const querySnapshot = await getDocs(q);
    
            if (querySnapshot.empty) {
              console.log(`No se encontró evaluación para actualizar: ${entidadId} (${tipo}) - ${mes}`);
              return false;
            }
    
            // Actualizar todos los documentos encontrados
            const updatePromises = [];
            querySnapshot.forEach((doc) => {
              console.log(`Actualizando estado de publicación del documento: ${doc.id}`);
              updatePromises.push(updateDoc(doc.ref, {
                estadoPublicacion: nuevoEstado,
                fechaPublicacion: new Date(),
                timestampPublicacion: Date.now()
              }));
            });
    
            await Promise.all(updatePromises);
            console.log(`Estado de publicación actualizado: ${entidadId} (${tipo}) - ${mes} -> ${nuevoEstado}`);
            return true;
          } catch (error) {
            console.error('Error actualizando estado de publicación:', error);
            throw error;
          }
        },

        // Verificar conexión a Firebase
        async verificarConexion() {
          try {
            const testCollection = collection(db, 'test');
            console.log('Conexión a Firebase establecida correctamente');
            return true;
          } catch (error) {
            console.error('Error conectando a Firebase:', error);
            return false;
          }
        }
      };

      console.log('Firebase configurado correctamente');
    </script>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="logo.png" alt="Café La Cabaña" class="logo-img"> <br>
                <h1>Sistema de Evaluaciones</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <span id="userRole" class="user-role"></span>
                <button onclick="cerrarSesion()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </header>
    
    <nav>
        <button class="tab-btn" data-section="dashboard">Dashboard</button>
        <button class="tab-btn" data-section="evaluaciones">Evaluaciones</button>
        <button class="tab-btn" data-section="matriz">Matriz</button>
        <button class="tab-btn" data-section="graficas">Gráficas</button>
        <button class="tab-btn" data-section="competencia">Competencia</button>
    </nav>
    <main>
        <section id="dashboard" class="tab-section">
            <div class="mes-selector-container">
                <label for="mes-selector">Mes de evaluación:</label>
                <select id="mes-selector"></select>
            </div>
            <!-- KPIs y resumen general -->
        </section>
        <section id="evaluaciones" class="tab-section" style="display:none"></section>
        <section id="matriz" class="tab-section" style="display:none">
            <h2>Matriz de Evaluación (Sucursales y Franquicias)</h2>
            <div id="tabla-matriz-container"></div>
        </section>
        <section id="graficas" class="tab-section" style="display:none">
            <canvas id="graficaResultados" width="600" height="300"></canvas>
        </section>
        <section id="competencia" class="tab-section" style="display:none">
            <!-- Contenido de la sección de competencia -->
        </section>
    </main>
    <script src="data/sucursales.js"></script>
    <script src="data/franquicias.js"></script>
    <script src="data/parametros.js"></script>
    <script src="data/parametros_excluidos.js"></script>
    <script src="data/competencia.js"></script>
    <script src="data/usuarios.js"></script>
    <script src="matriz.js"></script>
    <script src="auth.js"></script>
    <script src="utils.js"></script>
    <script src="dashboard.js"></script>
    <script src="script.js"></script>
    <style>
        /* Estilos para la tabla de evaluaciones */
        .evaluaciones-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .evaluaciones-table th,
        .evaluaciones-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .evaluaciones-table th {
            background-color: #0561ff;
            font-weight: bold;
        }
        
        /* Estilos para las celdas de KPI */
        .kpi-alto {
            background-color: #b7e1cd;
            color: #0b5394;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-medio {
            background-color: #ffe599;
            color: #7f6000;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-bajo {
            background-color: #f4cccc;
            color: #990000;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-na {
            background-color: #f3f3f3;
            color: #666666;
            text-align: center;
            font-style: italic;
        }
    </style>
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: block;">
      <div class="modal-content" style="max-width: 400px; margin: 10% auto;">
        <div class="modal-header">
          <h2><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</h2>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="Ingrese su email" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Contraseña:</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="Ingrese su contraseña" required>
          </div>
          <div id="loginError" class="error-message" style="display: none; color: #e74c3c; margin-top: 10px; text-align: center;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="iniciarSesion()">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
          </button>
        </div>
      </div>
    </div>
    <!-- Modal para nueva evaluación -->
    <div id="modal-nueva-evaluacion">
      <div class="modal-box">
        <button onclick="cerrarModalEvaluacion()" class="close-btn">&times;</button>
        <h2>Nueva evaluación</h2>
        <label for="select-entidad-evaluacion">Sucursal/Franquicia:</label>
        <select id="select-entidad-evaluacion" style="width:100%;margin-bottom:16px;">
          <option value="">Selecciona una opción</option>
          <!-- Opciones generadas por JS -->
        </select>
        <div id="parametros-evaluacion-container"></div>
        <div id="total-puntos-evaluacion" style="margin:18px 0 0 0;font-weight:600;font-size:1.08em;color:#0077cc;">Total de puntos: 0</div>
        <button id="btn-guardar-evaluacion" style="margin-top:16px;display:none;">Guardar evaluación</button>
      </div>
    </div>
    <footer>
      <img src="logch.png" alt="The Unknown Shopper" class="logo-TUS">
      <p>The Unknown Shopper &copy; 2025 | Todos los derechos reservados.</p>
    </footer>
</body>
</html>