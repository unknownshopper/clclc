<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Evaluaciones - Café La Cabaña</title>
    <link rel="stylesheet" href="style.css?v=eaf111a">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js CDN para gráficas -->

    <!-- Básicos -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Café La Cabaña - Evaluaciones y KPIs</title>
<meta name="description" content="Sistema de evaluaciones, KPIs y matriz de desempeño para Café La Cabaña con publicación y control por roles.">
<meta name="keywords" content="Café La Cabaña, evaluaciones, KPI, matriz, franquicias, sucursales">
<meta name="author" content="Unknown Shoppers MX">
<meta name="robots" content="noindex, nofollow"><!-- Cambia a index,follow si lo harás público -->

<!-- Canonical (ajusta a tu URL de producción/GitHub Pages) -->
<link rel="canonical" href="https://unknownshopper.github.io/clclc/">

<!-- Favicons / App icons -->
<link rel="icon" href="logchch.png" type="image/png">
<link rel="apple-touch-icon" href="logchch.png">

<!-- Tema del navegador y esquema de color -->
<meta name="theme-color" content="#0077cc">
<meta name="color-scheme" content="light only">

<!-- Open Graph (Facebook/LinkedIn) -->
<meta property="og:title" content="Café La Cabaña - Evaluaciones y KPIs">
<meta property="og:description" content="Dashboard, evaluaciones, KPIs y matriz y gráficas.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://unknownshopper.github.io/clclc/">
<meta property="og:image" content="https://unknownshopper.github.io/clclc/logchch.png"><!-- Usa URL absoluta -->

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Café La Cabaña  Evaluaciones y KPIs">
<meta name="twitter:description" content="Dashboard, evaluaciones, KPIs, matriz y gráficas.">
<meta name="twitter:image" content="https://unknownshopper.github.io/clclc/logchch.png">

<!-- PWA (opcional si luego agregas manifest/service worker) -->
<!-- <link rel="manifest" href="manifest.webmanifest"> -->
<!-- TODO: Crea manifest.webmanifest y vuelve a habilitar la línea superior para evitar 404 -->
<meta name="application-name" content="Evaluaciones CLC">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- Performance: preconnect/dns-prefetch para Firebase/CDNs (ajusta según lo que uses) -->
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
<link rel="preconnect" href="https://firebase.googleapis.com" crossorigin>
<link rel="dns-prefetch" href="https://www.gstatic.com">
<link rel="dns-prefetch" href="https://firestore.googleapis.com">
<link rel="dns-prefetch" href="https://firebase.googleapis.com"> 

<!-- Seguridades (ideales en cabeceras del servidor; aquí solo si no tienes backend) -->
<!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; img-src 'self' https: data:; style-src 'self' 'unsafe-inline' https:; script-src 'self' https://www.gstatic.com 'unsafe-inline'; connect-src 'self' https://firestore.googleapis.com https://firebase.googleapis.com;"> -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase Scripts -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      
      // Import Firebase configuration from separate file
      import { firebaseConfig } from './firebase-config.js';

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Import video links
      import { videoLinks } from './data/video_links.js';
      window.videoLinks = videoLinks;

      // Firebase Auth helpers (admin-only writes)
      window.firebaseAuth = {
        async signInAdmin(email, password) {
          // Ensures admin is authenticated in Firebase to perform writes
          await signInWithEmailAndPassword(auth, email, password);
        },
        async signOut() {
          try { await fbSignOut(auth); } catch (e) { console.warn('SignOut Firebase:', e?.message || e); }
        }
      };

      // Firebase functions for evaluations
      window.firebaseDB = {
        // Guardar evaluación en Firestore
        async guardarEvaluacion(evaluacionData) {
          try {
            const docRef = await addDoc(collection(db, 'evaluaciones'), {
              ...evaluacionData,
              fechaCreacion: new Date(),
              timestamp: Date.now()
            });
            console.log('Evaluación guardada en Firebase con ID:', docRef.id);
            return docRef.id;
          } catch (error) {
            console.error('Error guardando evaluación en Firebase:', error);
            throw error;
          }
        },

        // Cargar evaluaciones desde Firestore
        async cargarEvaluaciones(mes = null) {
          try {
            let q = collection(db, 'evaluaciones');
            
            if (mes) {
              q = query(q, where('mes', '==', mes), orderBy('fechaCreacion', 'desc'));
            } else {
              q = query(q, orderBy('fechaCreacion', 'desc'));
            }
            
            const querySnapshot = await getDocs(q);
            const evaluaciones = [];
            
            querySnapshot.forEach((doc) => {
              evaluaciones.push({
                id: doc.id,
                ...doc.data()
              });
            });
            
            console.log(`Cargadas ${evaluaciones.length} evaluaciones desde Firebase`);
            return evaluaciones;
          } catch (error) {
            console.error('Error cargando evaluaciones desde Firebase:', error);
            return [];
          }
        },

        // Eliminar evaluación de Firestore
        async eliminarEvaluacion(entidadId, tipo, mes) {
          try {
            // Buscar la evaluación por entidadId, tipo y mes
            const q = query(
              collection(db, 'evaluaciones'),
              where('entidadId', '==', entidadId),
              where('tipo', '==', tipo),
              where('mes', '==', mes)
            );
            
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
              console.log(`No se encontró evaluación para eliminar: ${entidadId} (${tipo}) - ${mes}`);
              return false;
            }
            
            // Eliminar todos los documentos que coincidan (debería ser solo uno)
            const deletePromises = [];
            querySnapshot.forEach((doc) => {
              console.log(`Eliminando documento Firebase: ${doc.id}`);
              deletePromises.push(deleteDoc(doc.ref));
            });
            
            await Promise.all(deletePromises);
            console.log(`Evaluación eliminada de Firebase: ${entidadId} (${tipo}) - ${mes}`);
            return true;
          } catch (error) {
            console.error('Error eliminando evaluación de Firebase:', error);
            throw error;
          }
        },

        // Actualizar evaluación en Firestore
        async actualizarEvaluacion(evaluacionId, datosActualizados) {
          try {
            await updateDoc(doc(db, 'evaluaciones', evaluacionId), {
              ...datosActualizados,
              fechaActualizacion: new Date(),
              timestampActualizacion: Date.now()
            });
            console.log('Evaluación actualizada en Firebase:', evaluacionId);
            return true;
          } catch (error) {
            console.error('Error actualizando evaluación en Firebase:', error);
            throw error;
          }
        },

        // Actualizar estado de publicación de una evaluación (opcionalmente con videoUrl)
        async actualizarEstadoPublicacion(entidadId, tipo, mes, nuevoEstado, videoUrl = null) {
          try {
            // Buscar la evaluación por entidadId, tipo y mes
            const q = query(
              collection(db, 'evaluaciones'),
              where('entidadId', '==', entidadId),
              where('tipo', '==', tipo),
              where('mes', '==', mes)
            );
    
            const querySnapshot = await getDocs(q);
    
            if (querySnapshot.empty) {
              console.log(`No se encontró evaluación para actualizar: ${entidadId} (${tipo}) - ${mes}`);
              return false;
            }
    
            // Actualizar todos los documentos encontrados
            const updatePromises = [];
            querySnapshot.forEach((doc) => {
              console.log(`Actualizando estado de publicación del documento: ${doc.id}`);
              const payload = {
                estadoPublicacion: nuevoEstado,
                fechaPublicacion: new Date(),
                timestampPublicacion: Date.now()
              };
              if (videoUrl && typeof videoUrl === 'string' && videoUrl.trim().length > 0) {
                payload.videoUrl = videoUrl.trim();
                payload.videoUrlUpdatedAt = new Date();
              }
              updatePromises.push(updateDoc(doc.ref, payload));
            });
    
            await Promise.all(updatePromises);
            console.log(`Estado de publicación actualizado: ${entidadId} (${tipo}) - ${mes} -> ${nuevoEstado}${videoUrl ? ' con videoUrl' : ''}`);
            return true;
          } catch (error) {
            console.error('Error actualizando estado de publicación:', error);
            throw error;
          }
        },

        // Verificar conexión a Firebase
        async verificarConexion() {
          try {
            const testCollection = collection(db, 'test');
            console.log('Conexión a Firebase establecida correctamente');
            return true;
          } catch (error) {
            console.error('Error conectando a Firebase:', error);
            return false;
          }
        }
      };

      console.log('Firebase configurado correctamente');
    </script>
    <!-- ExcelJS for XLSX export with embedded images -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
</head>
<body class="logged-out">
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="logo.png" alt="Café La Cabaña" class="logo-img"> <br>
                <h1>Sistema de Evaluaciones</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName"></span>
                <span id="userRole" class="user-role"></span>
                <button onclick="cerrarSesion()" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </header>
    
    <nav>
        <button class="tab-btn" data-section="dashboard">Dashboard</button>
        <button class="tab-btn" data-section="evaluaciones">Evaluaciones</button>
        <button class="tab-btn" data-section="matriz">Matriz</button>
        <button class="tab-btn" data-section="graficas">Gráficas</button>
        <button class="tab-btn" data-section="historico">Histórico</button>
        <button class="tab-btn" data-section="competencia">Competencia</button>
    </nav>
    <main>
        <section id="dashboard" class="tab-section">
            <div class="mes-selector-container">
                <label for="mes-selector">Mes de evaluación:</label>
                <select id="mes-selector"></select>
            </div>
            <!-- KPIs y resumen general -->
        </section>
        <section id="evaluaciones" class="tab-section" style="display:none"></section>
        <section id="matriz" class="tab-section" style="display:none">
            <h2>Matriz de Evaluación (Sucursales y Franquicias)</h2>
            <div id="tabla-matriz-container"></div>
        </section>
        <section id="graficas" class="tab-section" style="display:none">
            <canvas id="graficaResultados" width="600" height="300"></canvas>
        </section>
        <section id="competencia" class="tab-section" style="display:none">
            <!-- Contenido de la sección de competencia -->
        </section>
        <section id="historico" class="tab-section" style="display:none">
            <div style="margin-bottom: 20px;">
                <h2 style="color:#0077cc; text-align:center;">Histórico - Resultados Globales por Mes</h2>
                <p style="text-align:center; color:#666;">Promedio de KPI por mes considerando permisos del usuario</p>
            </div>
            <canvas id="graficoHistorico" width="800" height="380" style="max-width:100%;"></canvas>
        </section>
    </main>
    <script src="data/sucursales.js"></script>
    <script src="data/franquicias.js"></script>
    <script src="data/parametros.js"></script>
    <script src="data/parametros_excluidos.js"></script>
    <script src="data/competencia.js"></script>
    <script src="data/usuarios.js"></script>
    <script src="matriz.js"></script>
    <script src="auth.js"></script>
    <script src="utils.js"></script>
    <script src="dashboard.js"></script>
    <script src="data/historico.js"></script>
    <script src="script.js?v=dffba1e"></script>
    <style>
        /* Estilos para la tabla de evaluaciones */
        .evaluaciones-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .evaluaciones-table th,
        .evaluaciones-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .evaluaciones-table th {
            background-color: #0561ff;
            font-weight: bold;
        }
        
        /* Estilos para las celdas de KPI */
        .kpi-alto {
            background-color: #b7e1cd;
            color: #0b5394;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-medio {
            background-color: #ffe599;
            color: #7f6000;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-bajo {
            background-color: #f4cccc;
            color: #990000;
            font-weight: bold;
            text-align: center;
        }
        
        .kpi-na {
            background-color: #f3f3f3;
            color: #666666;
            text-align: center;
            font-style: italic;
        }
    </style>
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: block;">
      <div class="modal-content" style="max-width: 400px; margin: 10% auto;">
        <div class="modal-header">
          <h2><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</h2>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="Ingrese su email" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Contraseña:</label>
            <input type="password" id="loginPassword" class="form-control" placeholder="Ingrese su contraseña" required>
          </div>
          <div id="loginError" class="error-message" style="display: none; color: #e74c3c; margin-top: 10px; text-align: center;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="iniciarSesion()">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
          </button>
        </div>
      </div>
    </div>
    <!-- Modal para nueva evaluación -->
    <div id="modal-nueva-evaluacion">
      <div class="modal-box">
        <button onclick="cerrarModalEvaluacion()" class="close-btn">&times;</button>
        <h2>Nueva evaluación</h2>
        <label for="select-entidad-evaluacion">Sucursal/Franquicia:</label>
        <select id="select-entidad-evaluacion" style="width:100%;margin-bottom:16px;">
          <option value="">Selecciona una opción</option>
          <!-- Opciones generadas por JS -->
        </select>
        <div id="parametros-evaluacion-container"></div>
        <div id="total-puntos-evaluacion" style="margin:18px 0 0 0;font-weight:600;font-size:1.08em;color:#0077cc;">Total de puntos: 0</div>
        <button id="btn-guardar-evaluacion" style="margin-top:16px;display:none;">Guardar evaluación</button>
      </div>
    </div>
    <footer>
      
      <p>Powered by <a href="https://unknownshoppers.com"><img src="logch.png" alt="The Unknown Shopper" class="logo-TUS"></a> &copy; 2025 | Todos los derechos reservados.</p>
    </footer>
</body>
</html>